#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "xil_types.h"
#include "xil_cache.h"
#include "xparameters.h"
#include "xaxivdma.h"
#include "xaxivdma_i.h"
#include "emio_sccb_cfg/emio_sccb_cfg.h"
#include "ov5640/ov5640_init.h"

#include "cycle_num.h"
#include "sleep.h"
#include "vdma/vdma_api.h"
#include "main.h"

#include "CNN/conv_layer_1.h"
#include "CNN/param_init.h"

// 全局变量
XAxiVdma vdma;

int main(void)
{
	u32 status;
	u16 cmos_h_pixel;  // ov5640 DVP 输出水平像素点数
	u16 cmos_v_pixel;  // ov5640 DVP 输出垂直像素点数
	u16 total_h_pixel; // ov5640 水平总像素大小
	u16 total_v_pixel; // ov5640 垂直总像素大小

	cmos_h_pixel = 1280;
	cmos_v_pixel = 720;
	total_h_pixel = 2570;
	total_v_pixel = 980;

	emio_init();					   // 初始化EMIO
	status = ov5640_init(cmos_h_pixel, // 初始化ov5640
						 cmos_v_pixel,
						 total_h_pixel,
						 total_v_pixel);
	if (status == 0)
		xil_printf("OV5640 detected successful!\r\n");
	else
		xil_printf("OV5640 detected failed!\r\n");

	// 配置VDMA
	run_triple_frame_buffer(&vdma, VDMA_ID, WIDTH, HEIGHT, (int)FRAME_BUFFER_ADDR, 0, 0);

	// 载入参数
	conv_param_init();

	u8 img_data[] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
					 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
					 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
					 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
					 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 61, 3, 42, 118, 193, 118, 118, 61, 0, 0, 0, 0, 0, 0, 0, 0, 0,
					 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 14, 179, 245, 236, 242, 254, 254, 254, 254, 245, 235, 84, 0, 0, 0, 0, 0, 0, 0,
					 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 151, 254, 254, 254, 213, 192, 178, 178, 180, 254, 254, 241, 46, 0, 0, 0, 0, 0, 0,
					 7, 0, 0, 0, 0, 0, 0, 0, 0, 43, 235, 254, 226, 64, 28, 12, 0, 0, 2, 128, 252, 255, 173, 17, 0, 0, 0, 0, 0,
					 8, 0, 0, 0, 0, 0, 0, 0, 0, 56, 254, 253, 107, 0, 0, 0, 0, 0, 0, 0, 134, 250, 254, 75, 0, 0, 0, 0, 0,
					 9, 0, 0, 0, 0, 0, 0, 0, 0, 63, 254, 158, 0, 0, 0, 0, 0, 0, 0, 0, 0, 221, 254, 157, 0, 0, 0, 0, 0,
					 10, 0, 0, 0, 0, 0, 0, 0, 0, 194, 254, 103, 0, 0, 0, 0, 0, 0, 0, 0, 0, 150, 254, 213, 0, 0, 0, 0, 0,
					 11, 0, 0, 0, 0, 0, 0, 0, 34, 220, 239, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 84, 254, 213, 0, 0, 0, 0, 0,
					 12, 0, 0, 0, 0, 0, 0, 0, 126, 254, 171, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 84, 254, 213, 0, 0, 0, 0, 0,
					 13, 0, 0, 0, 0, 0, 0, 0, 214, 239, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 84, 254, 213, 0, 0, 0, 0, 0,
					 14, 0, 0, 0, 0, 0, 0, 0, 214, 199, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 84, 254, 213, 0, 0, 0, 0, 0,
					 15, 0, 0, 0, 0, 0, 0, 11, 219, 199, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 84, 254, 213, 0, 0, 0, 0, 0,
					 16, 0, 0, 0, 0, 0, 0, 98, 254, 199, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 162, 254, 209, 0, 0, 0, 0, 0,
					 17, 0, 0, 0, 0, 0, 0, 98, 254, 199, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 51, 238, 254, 75, 0, 0, 0, 0, 0,
					 18, 0, 0, 0, 0, 0, 0, 98, 254, 199, 0, 0, 0, 0, 0, 0, 0, 0, 0, 51, 165, 254, 195, 4, 0, 0, 0, 0, 0,
					 19, 0, 0, 0, 0, 0, 0, 66, 241, 199, 0, 0, 0, 0, 0, 0, 0, 0, 3, 167, 254, 227, 55, 0, 0, 0, 0, 0, 0,
					 20, 0, 0, 0, 0, 0, 0, 0, 214, 213, 20, 0, 0, 0, 0, 0, 46, 152, 202, 254, 254, 63, 0, 0, 0, 0, 0, 0, 0,
					 21, 0, 0, 0, 0, 0, 0, 0, 214, 254, 204, 180, 180, 180, 180, 180, 235, 254, 254, 234, 156, 10, 0, 0, 0, 0, 0, 0, 0,
					 22, 0, 0, 0, 0, 0, 0, 0, 81, 205, 254, 254, 254, 254, 254, 254, 254, 252, 234, 120, 0, 0, 0, 0, 0, 0, 0, 0, 0,
					 23, 0, 0, 0, 0, 0, 0, 0, 0, 26, 210, 254, 254, 254, 254, 254, 153, 104, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
					 24, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
					 25, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
					 26, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
					 27, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};

	/* 卷积层 */
	conv_layer_1(img_data);
	float *output = (float *)CONV1_OUT_BASEADDR;
	// 定义一个定长数组来存储输出数据
	float debug_output[30][24][24];

	// 将 output 中的数据复制到 debug_output 中
	for (int filter = 0; filter < 30; filter++)
	{
		for (int row = 0; row < 24; row++)
		{
			for (int col = 0; col < 24; col++)
			{
				debug_output[filter][row][col] = output[filter * (24 * 24) + row * 24 + col];
			}
		}
	}

	while (1)
	{
		/* code */
	}

	return 0;
}
